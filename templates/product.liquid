{% comment %}
templates/product.liquid - Completamente actualizado con snippets
Página de producto mejorada y más mantenible
{% endcomment %}

{% assign current_variant = product.selected_or_first_available_variant %}
{% assign featured_image = current_variant.featured_image | default: product.featured_image %}

<div class="background-animation"></div>

{% comment %}
BREADCRUMBS - Usando snippet para navegación
{% endcomment %}
{% render 'empire-breadcrumbs' %}

<div class="product-page-container">
    <div class="container">
        <div class="product-grid">
            {% comment %}
            SECCIÓN DE IMÁGENES DEL PRODUCTO
            {% endcomment %}
            <div class="product-images">
                <div class="main-image">
                    {% if featured_image %}
                        <img src="{{ featured_image | img_url: '800x800' }}" 
                             alt="{{ featured_image.alt | escape }}" 
                             class="product-main-image"
                             loading="eager">
                    {% else %}
                        <div class="no-image-placeholder">
                            <div class="product-icon-large">
                                {% render 'empire-icon', icon: 'trophy', size: 'xl' %}
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                {% if product.images.size > 1 %}
                <div class="thumbnail-images">
                    {% for image in product.images limit: 4 %}
                        <img src="{{ image | img_url: '200x200' }}" 
                             alt="{{ image.alt | escape }}" 
                             class="product-thumbnail" 
                             onclick="changeMainImage(this.src.replace('200x200', '800x800'))"
                             loading="lazy">
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            {% comment %}
            INFORMACIÓN DEL PRODUCTO
            {% endcomment %}
            <div class="product-info">
                {% comment %}
                BADGE DEL PRODUCTO
                {% endcomment %}
                <div class="product-badge">
                    {% if product.metafields.custom.badge %}
                        {{ product.metafields.custom.badge }}
                    {% else %}
                        {% render 'empire-icon', icon: 'crown', size: 'small' %}
                        EMPIRE EXCLUSIVE
                    {% endif %}
                </div>
                
                <h1 class="product-title">{{ product.title }}</h1>
                
                {% comment %}
                PRECIO - Usando snippet empire-price-display
                {% endcomment %}
                {% render 'empire-price-display', 
                   product: product,
                   variant: current_variant,
                   show_unit_price: true,
                   show_tax_info: true,
                   class: 'product-price-main' %}
                
                {% comment %}
                DESCRIPCIÓN DEL PRODUCTO
                {% endcomment %}
                <div class="product-description">
                    {{ product.description }}
                </div>
                
                {% comment %}
                LISTA DE CARACTERÍSTICAS - Mejorada con íconos
                {% endcomment %}
                {% if product.metafields.custom.features %}
                <div class="product-features-list">
                    <h3>{% render 'empire-icon', icon: 'check', size: 'small' %} What's Included:</h3>
                    <ul>
                        {% assign features = product.metafields.custom.features | split: ',' %}
                        {% for feature in features %}
                            <li>{% render 'empire-icon', icon: 'crown', size: 'small' %} {{ feature | strip }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                {% comment %}
                FORMULARIO DE PRODUCTO - Mejorado
                {% endcomment %}
                <form action="/cart/add" method="post" enctype="multipart/form-data" class="product-form">
                    {% unless product.has_only_default_variant %}
                        <div class="product-variants">
                            {% for option in product.options_with_values %}
                                <div class="variant-option">
                                    <label for="Option-{{ forloop.index0 }}">{{ option.name }}</label>
                                    <select name="id" id="Option-{{ forloop.index0 }}" class="variant-select">
                                        {% for value in option.values %}
                                            <option value="{{ value | escape }}" 
                                                    {% if option.selected_value == value %}selected="selected"{% endif %}>
                                                {{ value }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            {% endfor %}
                        {% else %}
                            <input type="hidden" name="id" value="{{ current_variant.id }}">
                    {% endunless %}
                    
                    <div class="product-quantity">
                        <label for="Quantity">
                            {% render 'empire-icon', icon: 'target', size: 'small' %}
                            Quantity
                        </label>
                        <input type="number" id="Quantity" name="quantity" value="1" min="1" class="quantity-input">
                    </div>
                    
                    {% comment %}
                    BOTONES DE ACCIÓN - Usando snippets empire-button
                    {% endcomment %}
                    <div class="product-buttons">
                        {% if current_variant.available %}
                            {% render 'empire-button',
                               text: "Dominate Now - " | append: current_variant.price | money,
                               style: "primary",
                               size: "large",
                               button_type: "submit",
                               icon_before: "crown",
                               full_width: true,
                               class: "btn-add-to-cart" %}
                        {% else %}
                            {% render 'empire-button',
                               text: "Sold Out",
                               style: "primary",
                               size: "large",
                               disabled: true,
                               full_width: true,
                               class: "btn-add-to-cart" %}
                        {% endif %}
                        
                        {% render 'empire-button',
                           text: "Buy Now - Instant Empire Access",
                           style: "secondary",
                           size: "large",
                           onclick: "buyNow()",
                           icon_before: "rocket",
                           full_width: true,
                           class: "btn-buy-now" %}
                    </div>
                </form>
                
                {% comment %}
                GARANTÍA DEL PRODUCTO
                {% endcomment %}
                <div class="product-guarantee">
                    <div class="guarantee-badge">
                        <span class="guarantee-icon">
                            {% render 'empire-icon', icon: 'shield', size: 'medium' %}
                        </span>
                        <div class="guarantee-text">
                            <strong>Empire Guarantee</strong>
                            <p>30-day domination guarantee or full refund</p>
                        </div>
                    </div>
                </div>
                
                {% comment %}
                PRUEBA SOCIAL
                {% endcomment %}
                <div class="product-social-proof">
                    <div class="social-proof-item">
                        <span class="proof-number">{{ product.metafields.custom.downloads | default: "1,247+" }}</span>
                        <span class="proof-label">
                            {% render 'empire-icon', icon: 'trophy', size: 'small' %}
                            Empire Builders
                        </span>
                    </div>
                    <div class="social-proof-item">
                        <span class="proof-number">⭐⭐⭐⭐⭐</span>
                        <span class="proof-label">Success Rate</span>
                    </div>
                </div>
                
                {% comment %}
                COMPARTIR EN REDES SOCIALES - Usando snippet
                {% endcomment %}
                {% render 'empire-social-share',
                   url: product.url,
                   title: product.title,
                   image: product.featured_image,
                   show_label: true,
                   share_label: "Share Your Victory:" %}
            </div>
        </div>
        
        {% comment %}
        TESTIMONIALES DEL PRODUCTO - Usando snippet
        {% endcomment %}
        {% if product.metafields.custom.testimonials %}
        <div class="product-testimonials">
            <h2 class="testimonials-title">
                {% render 'empire-icon', icon: 'crown', size: 'medium' %}
                Victory Stories
            </h2>
            <div class="testimonials-grid">
                {% assign testimonials = product.metafields.custom.testimonials | split: '|' %}
                {% for testimonial in testimonials limit: 3 %}
                    {% assign parts = testimonial | split: '~' %}
                    {% render 'empire-testimonial',
                       testimonial_text: parts[0] | strip,
                       author: parts[1] | strip,
                       rating: 5,
                       show_verification: true %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        {% comment %}
        PRODUCTOS RELACIONADOS
        {% endcomment %}
        {% if recommendations.products_count > 0 %}
        <div class="related-products">
            <h2 class="related-title">
                {% render 'empire-icon', icon: 'target', size: 'medium' %}
                Expand Your Empire
            </h2>
            <div class="related-products-grid">
                {% for product in recommendations.products limit: 4 %}
                    {% render 'empire-product-card',
                       product: product,
                       show_features: false,
                       button_text: "Add to Arsenal",
                       show_quick_view: true %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% comment %}
LOADING OVERLAY - Para estados de carga
{% endcomment %}
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    {% render 'empire-loading-spinner', 
       size: 'large', 
       loading_text: "Adding to Empire..." %}
</div>

{% comment %}
JAVASCRIPT MEJORADO
{% endcomment %}
<script>
// Función para cambiar imagen principal
function changeMainImage(src) {
    const mainImage = document.querySelector('.product-main-image');
    if (mainImage) {
        // Mostrar loading
        mainImage.style.opacity = '0.5';
        
        // Cambiar imagen
        mainImage.src = src;
        mainImage.onload = function() {
            mainImage.style.opacity = '1';
        };
    }
}

// Función mejorada para compra inmediata
function buyNow() {
    const form = document.querySelector('.product-form');
    const formData = new FormData(form);
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // Mostrar loading
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
    }
    
    fetch('/cart/add.js', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Ocultar loading
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
        
        // Redirect to checkout
        window.location.href = '/checkout';
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Ocultar loading
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }
        
        alert('Error adding to cart. Please try again.');
    });
}

// Manejo mejorado de selección de variantes
document.addEventListener('DOMContentLoaded', function() {
    const variantSelects = document.querySelectorAll('.variant-select');
    const productVariants = {{ product.variants | json }};
    const addButton = document.querySelector('.btn-add-to-cart');
    const buyButton = document.querySelector('.btn-buy-now');
    const priceDisplay = document.querySelector('.product-price-main');
    
    function updateVariant() {
        const selectedOptions = Array.from(variantSelects).map(select => select.value);
        const variant = productVariants.find(v => {
            return selectedOptions.every((option, index) => v.options[index] === option);
        });
        
        if (variant) {
            // Actualizar campo hidden
            const hiddenInput = document.querySelector('input[name="id"]');
            if (hiddenInput) {
                hiddenInput.value = variant.id;
            }
            
            // Actualizar precio usando el componente de precio
            if (priceDisplay) {
                updatePriceDisplay(variant);
            }
            
            // Actualizar disponibilidad de botones
            updateButtons(variant);
        }
    }
    
    function updatePriceDisplay(variant) {
        // Aquí podrías actualizar el display de precio
        // Por ahora, actualización básica
        const priceElement = document.querySelector('.price-current');
        if (priceElement) {
            priceElement.textContent = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: '{{ shop.currency }}'
            }).format(variant.price / 100);
        }
    }
    
    function updateButtons(variant) {
        if (variant.available) {
            if (addButton) {
                addButton.disabled = false;
                const btnText = addButton.querySelector('.btn-text');
                if (btnText) {
                    btnText.textContent = `Dominate Now - ${new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: '{{ shop.currency }}'
                    }).format(variant.price / 100)}`;
                }
            }
            if (buyButton) {
                buyButton.disabled = false;
            }
        } else {
            if (addButton) {
                addButton.disabled = true;
                const btnText = addButton.querySelector('.btn-text');
                if (btnText) {
                    btnText.textContent = 'Sold Out';
                }
            }
            if (buyButton) {
                buyButton.disabled = true;
            }
        }
    }
    
    // Event listeners para selects de variantes
    variantSelects.forEach(select => {
        select.addEventListener('change', updateVariant);
    });
    
    // Mejorar experiencia de thumbnails
    const thumbnails = document.querySelectorAll('.product-thumbnail');
    thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', function() {
            // Remover clase active de todos
            thumbnails.forEach(t => t.classList.remove('active'));
            // Agregar a actual
            this.classList.add('active');
        });
        
        // Marcar primera como activa
        if (index === 0) {
            thumb.classList.add('active');
        }
    });
});
</script>

{% comment %}
SCHEMA PARA CONFIGURACIONES ADICIONALES DEL PRODUCTO
{% endcomment %}
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": "{{ product.title | escape }}",
  "description": "{{ product.description | strip_html | escape }}",
  "image": [
    {% for image in product.images limit: 3 %}
      "{{ image | img_url: '800x800' }}"{% unless forloop.last %},{% endunless %}
    {% endfor %}
  ],
  "brand": {
    "@type": "Brand",
    "name": "{{ shop.name }}"
  },
  "offers": {
    "@type": "Offer",
    "url": "{{ shop.url }}{{ product.url }}",
    "priceCurrency": "{{ cart.currency.iso_code }}",
    "price": "{{ current_variant.price | money_without_currency }}",
    {% if current_variant.available %}
    "availability": "https://schema.org/InStock",
    {% else %}
    "availability": "https://schema.org/OutOfStock",
    {% endif %}
    "seller": {
      "@type": "Organization",
      "name": "{{ shop.name }}"
    }
  }
}
</script>
                
                <div class="product-social-proof">
                    <div class="social-proof-item">
                        <span class="proof-number">{{ product.metafields.custom.downloads | default: "1,247+" }}</span>
                        <span class="proof-label">Empire Builders</span>
                    </div>
                    <div class="social-proof-item">
                        <span class="proof-number">⭐⭐⭐⭐⭐</span>
                        <span class="proof-label">Success Rate</span>
                    </div>
                </div>
            </div>
        </div>
        
        {% if product.metafields.custom.testimonials %}
        <div class="product-testimonials">
            <h2 class="testimonials-title">Victory Stories</h2>
            <div class="testimonials-grid">
                {% assign testimonials = product.metafields.custom.testimonials | split: '|' %}
                {% for testimonial in testimonials limit: 3 %}
                    {% assign parts = testimonial | split: '~' %}
                    <div class="testimonial-card">
                        <p class="testimonial-text">"{{ parts[0] | strip }}"</p>
                        <p class="testimonial-author">- {{ parts[1] | strip }}</p>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function changeMainImage(src) {
    document.querySelector('.product-main-image').src = src;
}

function buyNow() {
    // Add to cart and redirect to checkout
    const form = document.querySelector('.product-form');
    const formData = new FormData(form);
    
    fetch('/cart/add.js', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = '/checkout';
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Variant selection handling
document.querySelectorAll('.variant-select').forEach(select => {
    select.addEventListener('change', function() {
        // Update variant based on selections
        const options = Array.from(document.querySelectorAll('.variant-select')).map(s => s.value);
        const variant = {{ product.variants | json }}.find(v => {
            return options.every((option, index) => v.options[index] === option);
        });
        
        if (variant) {
            document.querySelector('input[name="id"]').value = variant.id;
            document.querySelector('.price').textContent = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: '{{ shop.currency }}'
            }).format(variant.price / 100);
            
            const addButton = document.querySelector('.btn-add-to-cart');
            const buyButton = document.querySelector('.btn-buy-now');
            
            if (variant.available) {
                addButton.disabled = false;
                addButton.querySelector('.btn-text').textContent = `Dominate Now - ${new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: '{{ shop.currency }}'
                }).format(variant.price / 100)}`;
                buyButton.disabled = false;
            } else {
                addButton.disabled = true;
                addButton.querySelector('.btn-text').textContent = 'Sold Out';
                buyButton.disabled = true;
            }
        }
    });
});
</script>
