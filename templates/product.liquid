{% assign current_variant = product.selected_or_first_available_variant %}
{% assign featured_image = current_variant.featured_image | default: product.featured_image %}

<div class="background-animation"></div>

<div class="product-page-container">
    <div class="container">
        <div class="product-grid">
            <div class="product-images">
                <div class="main-image">
                    {% if featured_image %}
                        <img src="{{ featured_image | img_url: '800x800' }}" alt="{{ featured_image.alt | escape }}" class="product-main-image">
                    {% else %}
                        <div class="no-image-placeholder">
                            <div class="product-icon-large">üèÜ</div>
                        </div>
                    {% endif %}
                </div>
                
                {% if product.images.size > 1 %}
                <div class="thumbnail-images">
                    {% for image in product.images limit: 4 %}
                        <img src="{{ image | img_url: '200x200' }}" alt="{{ image.alt | escape }}" class="product-thumbnail" onclick="changeMainImage(this.src.replace('200x200', '800x800'))">
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <div class="product-info">
                <div class="product-badge">
                    {% if product.metafields.custom.badge %}
                        {{ product.metafields.custom.badge }}
                    {% else %}
                        EMPIRE EXCLUSIVE
                    {% endif %}
                </div>
                
                <h1 class="product-title">{{ product.title }}</h1>
                
                <div class="product-price">
                    <span class="price">{{ current_variant.price | money }}</span>
                    {% if current_variant.compare_at_price > current_variant.price %}
                        <span class="compare-price">{{ current_variant.compare_at_price | money }}</span>
                        <span class="save-amount">Save {{ current_variant.compare_at_price | minus: current_variant.price | money }}</span>
                    {% endif %}
                </div>
                
                <div class="product-description">
                    {{ product.description }}
                </div>
                
                {% if product.metafields.custom.features %}
                <div class="product-features-list">
                    <h3>What's Included:</h3>
                    <ul>
                        {% assign features = product.metafields.custom.features | split: ',' %}
                        {% for feature in features %}
                            <li>üëë {{ feature | strip }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <form action="/cart/add" method="post" enctype="multipart/form-data" class="product-form">
                    {% unless product.has_only_default_variant %}
                        <div class="product-variants">
                            {% for option in product.options_with_values %}
                                <div class="variant-option">
                                    <label for="Option-{{ forloop.index0 }}">{{ option.name }}</label>
                                    <select name="id" id="Option-{{ forloop.index0 }}" class="variant-select">
                                        {% for value in option.values %}
                                            <option value="{{ value | escape }}" {% if option.selected_value == value %}selected="selected"{% endif %}>
                                                {{ value }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            {% endfor %}
                        {% else %}
                            <input type="hidden" name="id" value="{{ current_variant.id }}">
                    {% endunless %}
                    
                    <div class="product-quantity">
                        <label for="Quantity">Quantity</label>
                        <input type="number" id="Quantity" name="quantity" value="1" min="1" class="quantity-input">
                    </div>
                    
                    <div class="product-buttons">
                        <button type="submit" name="add" class="btn-add-to-cart" {% unless current_variant.available %}disabled{% endunless %}>
                            {% if current_variant.available %}
                                <span class="btn-text">Dominate Now - {{ current_variant.price | money }}</span>
                            {% else %}
                                <span class="btn-text">Sold Out</span>
                            {% endif %}
                        </button>
                        
                        <button type="button" class="btn-buy-now" onclick="buyNow()">
                            Buy Now - Instant Empire Access
                        </button>
                    </div>
                </form>
                
                <div class="product-guarantee">
                    <div class="guarantee-badge">
                        <span class="guarantee-icon">üõ°Ô∏è</span>
                        <div class="guarantee-text">
                            <strong>Empire Guarantee</strong>
                            <p>30-day domination guarantee or full refund</p>
                        </div>
                    </div>
                </div>
                
                <div class="product-social-proof">
                    <div class="social-proof-item">
                        <span class="proof-number">{{ product.metafields.custom.downloads | default: "1,247+" }}</span>
                        <span class="proof-label">Empire Builders</span>
                    </div>
                    <div class="social-proof-item">
                        <span class="proof-number">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</span>
                        <span class="proof-label">Success Rate</span>
                    </div>
                </div>
            </div>
        </div>
        
        {% if product.metafields.custom.testimonials %}
        <div class="product-testimonials">
            <h2 class="testimonials-title">Victory Stories</h2>
            <div class="testimonials-grid">
                {% assign testimonials = product.metafields.custom.testimonials | split: '|' %}
                {% for testimonial in testimonials limit: 3 %}
                    {% assign parts = testimonial | split: '~' %}
                    <div class="testimonial-card">
                        <p class="testimonial-text">"{{ parts[0] | strip }}"</p>
                        <p class="testimonial-author">- {{ parts[1] | strip }}</p>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function changeMainImage(src) {
    document.querySelector('.product-main-image').src = src;
}

function buyNow() {
    // Add to cart and redirect to checkout
    const form = document.querySelector('.product-form');
    const formData = new FormData(form);
    
    fetch('/cart/add.js', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = '/checkout';
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Variant selection handling
document.querySelectorAll('.variant-select').forEach(select => {
    select.addEventListener('change', function() {
        // Update variant based on selections
        const options = Array.from(document.querySelectorAll('.variant-select')).map(s => s.value);
        const variant = {{ product.variants | json }}.find(v => {
            return options.every((option, index) => v.options[index] === option);
        });
        
        if (variant) {
            document.querySelector('input[name="id"]').value = variant.id;
            document.querySelector('.price').textContent = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: '{{ shop.currency }}'
            }).format(variant.price / 100);
            
            const addButton = document.querySelector('.btn-add-to-cart');
            const buyButton = document.querySelector('.btn-buy-now');
            
            if (variant.available) {
                addButton.disabled = false;
                addButton.querySelector('.btn-text').textContent = `Dominate Now - ${new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: '{{ shop.currency }}'
                }).format(variant.price / 100)}`;
                buyButton.disabled = false;
            } else {
                addButton.disabled = true;
                addButton.querySelector('.btn-text').textContent = 'Sold Out';
                buyButton.disabled = true;
            }
        }
    });
});
</script>